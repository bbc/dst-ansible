---
# - name: Register host to Satellite Capsule
#   shell: |
#     subscription-manager config --server.no_proxy=*
#     subscription-manager register --org="{{ sat_org }}" --activationkey="{{ sat_key }}"

- name: Download Satellite Capsule config
  uri:
    url: https://{{ sat_capsule }}/pub/katello-ca-consumer-latest.noarch.rpm
    validate_certs: no
    dest: /tmp/

- name: Install Satellite Capsule katello-ca config
  yum:
    name: /tmp/katello-ca-consumer-latest.noarch.rpm
    state: present

- name: Set Satellite config to no_proxy
  cmd: subscription-manager config --server.no_proxy=*
  args:
    warn: no

- name: Register host with activationkey
  redhat_subscription:
    state: present
    activationkey: "{{ sat_key }}"
    org_id: "{{ sat_org }}"
